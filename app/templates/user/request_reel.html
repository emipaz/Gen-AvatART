{#
Template para solicitar creación de reel con avatar específico.

Este template permite a usuarios finales crear una solicitud formal para
generar un reel usando un avatar disponible. La solicitud requiere aprobación
del productor propietario del avatar antes de proceder.

El template incluye:
    - Información del avatar seleccionado
    - Formulario completo de solicitud de reel
    - Advertencia sobre proceso de aprobación
    - Vista previa de configuraciones
    - Información del productor que revisará

Variables Jinja utilizadas:
    - form: Formulario de solicitud (ReelRequestForm)
    - avatar: Información del avatar seleccionado
    - producer: Productor propietario que debe aprobar
    - current_user: Usuario autenticado

Flujo UX:
    1. Usuario selecciona avatar desde vista de avatares
    2. Ve información del avatar y productor
    3. Llena formulario con título, script, configuraciones
    4. Recibe advertencia sobre aprobación requerida
    5. Envía solicitud y recibe confirmación
#}

{% extends "base.html" %}

{% block title %}Solicitar Reel: {{ avatar.name }} - Gem-AvatART{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-10">
            
            <!-- ===== HEADER CON INFORMACIÓN DEL AVATAR ===== -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-video"></i> 
                        Solicitar Reel con: {{ avatar.name }}
                    </h4>
                </div>
                <div class="card-body">
                    <div class="row">
                        <!-- Avatar Preview -->
                        <div class="col-md-4">
                            {% if avatar.thumbnail_url %}
                                <img src="{{ avatar.thumbnail_url }}" 
                                     class="img-fluid rounded" 
                                     alt="{{ avatar.name }}"
                                     style="max-height: 200px; object-fit: cover;">
                            {% else %}
                                <div class="bg-light rounded d-flex align-items-center justify-content-center" 
                                     style="height: 200px;">
                                    <i class="fas fa-user-circle fa-4x text-muted"></i>
                                </div>
                            {% endif %}
                        </div>
                        
                        <!-- Avatar Info -->
                        <div class="col-md-8">
                            <h5>{{ avatar.name }}</h5>
                            {% if avatar.description %}
                                <p class="text-muted">{{ avatar.description }}</p>
                            {% endif %}
                            
                            <div class="row mb-3">
                                <div class="col-sm-6">
                                    <strong>Tipo de acceso:</strong>
                                    <span class="badge bg-{{ 'success' if avatar.access_type.value == 'public' else 'warning' if avatar.access_type.value == 'premium' else 'info' }}">
                                        {{ avatar.access_type.value.title() }}
                                    </span>
                                </div>
                                <div class="col-sm-6">
                                    <strong>Idioma:</strong> {{ avatar.language or 'Español' }}
                                </div>
                            </div>
                            
                            <!-- Información del Productor -->
                            <div class="alert alert-info">
                                <h6 class="mb-2">
                                    <i class="fas fa-user-tie"></i> 
                                    Productor: {{ producer.display_name }}
                                </h6>
                                <p class="mb-0 small">
                                    Tu solicitud será revisada por {{ producer.display_name }}. 
                                    Recibirás una notificación cuando sea aprobada o rechazada.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ===== ADVERTENCIA DE APROBACIÓN ===== -->
            <div class="alert alert-warning mb-4">
                <h5 class="alert-heading">
                    <i class="fas fa-exclamation-triangle"></i> 
                    Solicitud Requiere Aprobación
                </h5>
                <p class="mb-2">
                    <strong>Este reel debe ser aprobado por {{ producer.display_name }} antes de ser creado.</strong>
                </p>
                <p class="mb-0 small">
                    • La solicitud será enviada al productor para revisión<br>
                    • Recibirás una notificación cuando sea aprobada o rechazada<br>
                    • Si es aprobada, el reel se creará automáticamente<br>
                    • Puedes ver el estado de tus solicitudes en tu dashboard
                </p>
            </div>
            
            <!-- ===== FORMULARIO DE SOLICITUD ===== -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-edit"></i> 
                        Información del Reel Solicitado
                    </h5>
                </div>
                <div class="card-body">
                    
                    <form method="POST" enctype="multipart/form-data">
                        {{ form.hidden_tag() }}
                        {{ form.avatar_id() }}
                        
                        <!-- Título del Reel -->
                        <div class="mb-3">
                            {{ form.title.label(class="form-label") }}
                            {{ form.title(class="form-control" + (" is-invalid" if form.title.errors else "")) }}
                            {% if form.title.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.title.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <div class="form-text">
                                Un título descriptivo para tu reel (3-200 caracteres)
                            </div>
                        </div>
                        
                        <!-- Script del Avatar -->
                        <div class="mb-3">
                            {{ form.script.label(class="form-label") }}
                            {{ form.script(class="form-control" + (" is-invalid" if form.script.errors else ""), rows="4", placeholder="Escribe aquí el texto que quieres que diga el avatar...") }}
                            {% if form.script.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.script.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <div class="form-text">
                                El texto que pronunciará el avatar en el video (10-2000 caracteres)
                            </div>
                        </div>
                        
                        <!-- Selector de Voz -->
                        <div class="mb-3">
                            {{ form.voice_id.label(class="form-label") }}
                            <!-- Campo hidden para capturar el voice_id seleccionado -->
                            {{ form.voice_id(type="hidden", id="voice_id_field") }}
                            <div id="voice-required-info" class="alert alert-info mb-2" style="display: none;">
                                <i class="fas fa-info-circle"></i>
                                <span id="voice-required-message"></span>
                            </div>
                            <div id="voice-selector-container">
                                <div class="text-center py-4">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Cargando voces...</span>
                                    </div>
                                    <p class="text-muted mt-2">Cargando voces disponibles...</p>
                                </div>
                            </div>
                            <div class="form-text">
                                <span id="voice-help-text">Selecciona la voz que usará el avatar. Puedes escuchar una muestra antes de elegir.</span>
                            </div>
                        </div>

                            <!-- Velocidad de la voz -->
                            <div class="mb-3">
                                <label for="speed_slider" class="form-label">Velocidad de la voz</label>
                                <input type="range" name="speed" id="speed_slider" class="form-range" min="0.5" max="1.5" step="0.05" value="{{ form.speed.data or 1.0 }}" oninput="speed_value.innerText = this.value">
                                <div class="d-flex justify-content-between">
                                    <small>0.50</small>
                                    <span id="speed_value">{{ form.speed.data or 1.0 }}</span>
                                    <small>1.50</small>
                                </div>
                                <div class="form-text">Rango: 0.50 (lento) a 1.50 (rápido). Valor por defecto: 1.0</div>
                            </div>

                            <!-- Pitch de la voz -->
                            <div class="mb-3">
                                <label for="pitch_slider" class="form-label">Pitch de la voz</label>
                                <input type="range" name="pitch" id="pitch_slider" class="form-range" min="-50" max="50" step="1" value="{{ form.pitch.data or 0 }}" oninput="pitch_value.innerText = this.value">
                                <div class="d-flex justify-content-between">
                                    <small>-50</small>
                                    <span id="pitch_value">{{ form.pitch.data or 0 }}</span>
                                    <small>50</small>
                                </div>
                                <div class="form-text">Rango: -50 (grave) a 50 (agudo). Valor por defecto: 0</div>
                            </div>
                        
                        <!-- Configuraciones del Video -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                {{ form.resolution.label(class="form-label") }}
                                {{ form.resolution(class="form-select") }}
                                <div class="form-text">
                                    Calidad del video generado
                                </div>
                            </div>
                        </div>
                        
                        <!-- Fondo del Video con Tabs -->
                        <div class="mb-3">
                            <label class="form-label">Fondo del Video (opcional)</label>
                            
                            <!-- Nav tabs -->
                            <ul class="nav nav-tabs" id="backgroundTabs" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="url-tab" data-bs-toggle="tab" data-bs-target="#url-content" type="button" role="tab">
                                        <i class="fas fa-link"></i> URL de Imagen
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="upload-tab" data-bs-toggle="tab" data-bs-target="#upload-content" type="button" role="tab">
                                        <i class="fas fa-upload"></i> Subir Imagen
                                    </button>
                                </li>
                            </ul>
                            
                            <!-- Tab content -->
                            <div class="tab-content border border-top-0 p-3" id="backgroundTabContent">
                                <!-- URL Tab -->
                                <div class="tab-pane fade show active" id="url-content" role="tabpanel">
                                    {{ form.background_url(class="form-control" + (" is-invalid" if form.background_url.errors else ""), placeholder="https://ejemplo.com/fondo.jpg") }}
                                    {% if form.background_url.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.background_url.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                    <div class="form-text">
                                        <i class="fas fa-info-circle"></i> Proporciona la URL de una imagen alojada en internet (JPG, PNG, WEBP)
                                    </div>
                                </div>
                                
                                <!-- Upload Tab -->
                                <div class="tab-pane fade" id="upload-content" role="tabpanel">
                                    {{ form.background_image(class="form-control" + (" is-invalid" if form.background_image.errors else "")) }}
                                    {% if form.background_image.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.background_image.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                    <div class="form-text">
                                        <i class="fas fa-info-circle"></i> Sube una imagen desde tu computadora (máx. 5MB, formatos: JPG, PNG, WEBP)
                                    </div>
                                </div>
                            </div>
                            
                            <div class="alert alert-info mt-2 small">
                                <i class="fas fa-lightbulb"></i> <strong>Nota:</strong> Si proporcionas ambos (URL y archivo), se usará el archivo subido. Si no proporcionas ninguno, se usará un fondo predeterminado.
                            </div>
                        </div>
                        
                        <!-- Notas para el Productor -->
                        <div class="mb-4">
                            {{ form.user_notes.label(class="form-label") }}
                            {{ form.user_notes(class="form-control", rows="3", placeholder="Información adicional para el productor (opcional)...") }}
                            <div class="form-text">
                                Comparte detalles adicionales, contexto o instrucciones especiales para el productor
                            </div>
                        </div>
                        
                        <!-- Botones de Acción -->
                        <div class="d-flex justify-content-between">
                            <a href="{{ url_for('user.avatars') }}" class="btn btn-outline-secondary">
                                <i class="fas fa-arrow-left"></i> Volver a Avatares
                            </a>
                            
                            {{ form.submit(class="btn btn-primary btn-lg") }}
                        </div>
                        
                    </form>
                    
                </div>
            </div>
            
            <!-- ===== INFORMACIÓN ADICIONAL ===== -->
            <div class="mt-4">
                <div class="card border-light">
                    <div class="card-body">
                        <h6 class="text-muted mb-2">
                            <i class="fas fa-info-circle"></i> 
                            ¿Qué sucede después?
                        </h6>
                        <ol class="text-muted small mb-0">
                            <li>Tu solicitud será enviada a {{ producer.display_name }}</li>
                            <li>El productor revisará tu solicitud y la aprobará o rechazará</li>
                            <li>Recibirás una notificación por email con la decisión</li>
                            <li>Si es aprobada, el reel se creará automáticamente</li>
                            <li>Podrás descargar tu reel desde tu dashboard una vez completado</li>
                        </ol>
                    </div>
                </div>
            </div>
            
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const avatarId = {{ avatar.id }};
    const voiceContainer = document.getElementById('voice-selector-container');
    let currentAudio = null;
    let allVoices = [];
    let defaultVoiceId = null;
    const formElement = document.querySelector('form');
    
    // Mostrar info sobre voz requerida/opcional
    function updateVoiceRequiredInfo() {
        const infoDiv = document.getElementById('voice-required-info');
        const messageSpan = document.getElementById('voice-required-message');
        const helpText = document.getElementById('voice-help-text');
        
        // Validar que los elementos existan
        if (!infoDiv || !messageSpan || !helpText) {
            console.warn('Elementos de info de voz no encontrados en el DOM');
            return;
        }
        
        if (defaultVoiceId) {
            infoDiv.style.display = 'block';
            infoDiv.className = 'alert alert-success mb-2';
            messageSpan.textContent = 'Este avatar tiene una voz predeterminada. Puedes dejarla seleccionada o elegir otra.';
            helpText.textContent = 'Opcional: Puedes cambiar la voz si lo deseas.';
        } else {
            infoDiv.style.display = 'block';
            infoDiv.className = 'alert alert-warning mb-2';
            messageSpan.innerHTML = '<strong>Importante:</strong> Este avatar no tiene voz predeterminada. Debes seleccionar una.';
            helpText.textContent = 'Obligatorio: Selecciona una voz para continuar.';
        }
    }
    
    // Validación antes de enviar el formulario
    formElement.addEventListener('submit', function(e) {
        if (!defaultVoiceId) {
            // Si no hay voz por defecto, verificar que se haya seleccionado una
            const selectedVoice = document.querySelector('input[name="voice_id"]:checked');
            if (!selectedVoice || !selectedVoice.value) {
                e.preventDefault();
                alert('Por favor, selecciona una voz para el avatar antes de continuar.');
                
                // Hacer scroll hasta el selector de voces
                document.getElementById('voice-selector-container').scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'center' 
                });
                return false;
            }
        }
    });
    
    // Cargar voces disponibles
    fetch(`/api/avatars/${avatarId}/voices`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                voiceContainer.innerHTML = `
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i> 
                        <strong>Problema al cargar voces:</strong><br>
                        ${data.error}
                        <hr>
                        <small>
                            <i class="fas fa-info-circle"></i> 
                            Puedes continuar creando el reel. Si el avatar tiene una voz predeterminada, se usará automáticamente.
                            ${data.default_voice_id ? `<br><strong>Voz predeterminada disponible:</strong> Se usará la voz original del avatar.` : ''}
                        </small>
                    </div>
                `;
                // Si hay voz por defecto, actualizar la info
                if (data.default_voice_id) {
                    defaultVoiceId = data.default_voice_id;
                    updateVoiceRequiredInfo();
                }
                return;
            }
            
            allVoices = data.voices;
            defaultVoiceId = data.default_voice_id;
            updateVoiceRequiredInfo();
            renderVoiceSelector(allVoices);
        })
        .catch(error => {
            console.error('Error al cargar voces:', error);
            voiceContainer.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-times-circle"></i> 
                    <strong>Error de conexión</strong><br>
                    No se pudieron cargar las voces disponibles. Verifica tu conexión e intenta recargar la página.
                </div>
            `;
        });
    
    function renderVoiceSelector(voices) {
        if (!voices || voices.length === 0) {
            voiceContainer.innerHTML = `
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> 
                    No hay voces disponibles para este avatar
                </div>
            `;
            return;
        }
        
        // Extraer idiomas y géneros únicos
        const languages = [...new Set(voices.map(v => v.language))].sort();
        const genders = [...new Set(voices.map(v => v.gender))].sort();
        
        // Capitalizar primera letra de gender para display
        const capitalizeFirst = (str) => str.charAt(0).toUpperCase() + str.slice(1);
        
        let html = `
            <!-- Filtros -->
            <div class="card mb-3">
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label for="search-voice" class="form-label">
                                <i class="fas fa-search"></i> Buscar por nombre
                            </label>
                            <input type="text" 
                                   class="form-control" 
                                   id="search-voice" 
                                   placeholder="Escribe para buscar...">
                        </div>
                        <div class="col-md-4">
                            <label for="filter-language" class="form-label">
                                <i class="fas fa-language"></i> Idioma
                            </label>
                            <select class="form-select" id="filter-language">
                                <option value="">Todos los idiomas (${voices.length})</option>
                                ${languages.map(lang => {
                                    const count = voices.filter(v => v.language === lang).length;
                                    return `<option value="${lang}">${lang} (${count})</option>`;
                                }).join('')}
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="filter-gender" class="form-label">
                                <i class="fas fa-venus-mars"></i> Género
                            </label>
                            <select class="form-select" id="filter-gender">
                                <option value="">Todos (${voices.length})</option>
                                ${genders.map(gender => {
                                    const count = voices.filter(v => v.gender === gender).length;
                                    return `<option value="${gender}">${capitalizeFirst(gender)} (${count})</option>`;
                                }).join('')}
                            </select>
                        </div>
                    </div>
                    <div class="mt-2">
                        <small class="text-muted">
                            <i class="fas fa-info-circle"></i> 
                            Mostrando <span id="voice-count">${voices.length}</span> de ${allVoices.length} voces
                        </small>
                    </div>
                </div>
            </div>
            
            <!-- Lista de voces -->
            <div id="voices-list">
        `;
        
        // Si hay voz por defecto, agregar opción para mantenerla (SIEMPRE VISIBLE, FUERA DEL SCROLL)
        if (defaultVoiceId) {
            html += `
                <div class="card mb-3 border-success">
                    <div class="card-body p-3 bg-light">
                        <div class="list-group-item list-group-item-action voice-option-default border-success active" 
                             data-voice-id=""
                             style="cursor: pointer; background-color: #d1f4d1; border: 2px solid #28a745;">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="flex-grow-1">
                                    <div class="d-flex align-items-center">
                                        <input type="radio" 
                                               name="voice_id" 
                                               value="" 
                                               id="voice_default"
                                               checked
                                               class="form-check-input me-2">
                                        <label for="voice_default" class="mb-0 flex-grow-1" style="cursor: pointer;">
                                            <strong><i class="fas fa-check-circle text-success"></i> Usar voz predeterminada del avatar</strong>
                                            <span class="badge bg-success ms-2">Recomendado</span>
                                            <br>
                                            <small class="text-muted">
                                                <i class="fas fa-info-circle"></i> Esta es la voz original del avatar. Siempre disponible independiente de los filtros.
                                            </small>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="mb-2">
                    <strong><i class="fas fa-list"></i> O elige una voz diferente:</strong>
                </div>
            `;
        }
        
        // Contenedor con scroll para otras voces
        html += `<div class="voices-scrollable-list" style="max-height: 400px; overflow-y: auto;">`;
        
        voices.forEach(voice => {
            const isDefault = voice.is_default;
            const badgeClass = 'bg-secondary';
            const badgeText = isDefault ? 'Voz original del avatar' : '';
            
            html += `
                <div class="list-group-item list-group-item-action voice-option" 
                     data-voice-id="${voice.voice_id}"
                     data-language="${voice.language}"
                     data-gender="${voice.gender}"
                     data-name="${voice.name.toLowerCase()}"
                     style="cursor: pointer;">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="flex-grow-1">
                            <div class="d-flex align-items-center">
                                <input type="radio" 
                                       name="voice_id" 
                                       value="${voice.voice_id}" 
                                       id="voice_${voice.voice_id}"
                                       class="form-check-input me-2">
                                <label for="voice_${voice.voice_id}" class="mb-0 flex-grow-1" style="cursor: pointer;">
                                    <strong>${voice.name}</strong>
                                    ${badgeText ? `<span class="badge ${badgeClass} ms-2">${badgeText}</span>` : ''}
                                    <br>
                                    <small class="text-muted">
                                        <i class="fas fa-language"></i> ${voice.language} 
                                        <i class="fas fa-${voice.gender === 'male' ? 'mars' : voice.gender === 'female' ? 'venus' : 'genderless'} ms-2"></i> 
                                        ${voice.gender}
                                    </small>
                                </label>
                            </div>
                        </div>
                        ${voice.preview_audio ? `
                        <button type="button" 
                                class="btn btn-sm btn-outline-primary play-voice-btn ms-2" 
                                data-audio-url="${voice.preview_audio}"
                                data-voice-id="${voice.voice_id}">
                            <i class="fas fa-play"></i> Preview
                        </button>
                        ` : ''}
                    </div>
                </div>
            `;
        });
        
        html += '</div></div>'; // Cerrar voices-scrollable-list y voices-list
        voiceContainer.innerHTML = html;
        
        // Event listener para la opción de voz predeterminada (fuera del filtrado)
        const defaultOption = document.querySelector('.voice-option-default');
        if (defaultOption) {
            defaultOption.addEventListener('click', function(e) {
                const radio = document.getElementById('voice_default');
                radio.checked = true;
                
                // Actualizar campo hidden
                const hiddenField = document.getElementById('voice_id_field');
                if (hiddenField) {
                    hiddenField.value = radio.value;
                }
                
                // Desmarcar todas las otras voces
                document.querySelectorAll('.voice-option').forEach(opt => {
                    opt.classList.remove('active');
                });
                this.classList.add('active');
            });
        }
        
        // Event listeners para filtros
        document.getElementById('search-voice').addEventListener('input', filterVoices);
        document.getElementById('filter-language').addEventListener('change', filterVoices);
        document.getElementById('filter-gender').addEventListener('change', filterVoices);
        
        // Event listeners para seleccionar voz
        attachVoiceListeners();
    }
    
    function filterVoices() {
        const searchTerm       = document.getElementById('search-voice').value.toLowerCase();
        const selectedLanguage = document.getElementById('filter-language').value;
        const selectedGender   = document.getElementById('filter-gender').value;
        
        const voiceOptions = document.querySelectorAll('.voice-option');
        let visibleCount   = 0;
        
        voiceOptions.forEach(option => {
            const name     = option.dataset.name;
            const language = option.dataset.language;
            const gender   = option.dataset.gender;
            
            const matchesSearch   = !searchTerm || name.includes(searchTerm);
            const matchesLanguage = !selectedLanguage || language === selectedLanguage;
            const matchesGender   = !selectedGender || gender === selectedGender;
            
            if (matchesSearch && matchesLanguage && matchesGender) {
                option.style.display = '';
                visibleCount++;
            } else {
                option.style.display = 'none';
            }
        });
        
        // Actualizar contador
        document.getElementById('voice-count').textContent = visibleCount;
    }
    
    function attachVoiceListeners() {
        // Event listeners para seleccionar voz (solo las voces dentro del scroll)
        document.querySelectorAll('.voice-option').forEach(option => {
            option.addEventListener('click', function(e) {
                if (e.target.closest('.play-voice-btn')) return;
                
                const voiceId = this.dataset.voiceId;
                const radio = document.getElementById(`voice_${voiceId}`);
                radio.checked = true;
                
                // Actualizar campo hidden
                const hiddenField = document.getElementById('voice_id_field');
                if (hiddenField) {
                    hiddenField.value = voiceId;
                }
                
                document.querySelectorAll('.voice-option').forEach(opt => {
                    opt.classList.remove('active');
                });
                
                // Desmarcar la opción predeterminada si existe
                const defaultOption = document.querySelector('.voice-option-default');
                if (defaultOption) {
                    defaultOption.classList.remove('active');
                }
                
                this.classList.add('active');
            });
        });
        
        // Event listeners para preview de audio
        document.querySelectorAll('.play-voice-btn').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.stopPropagation();
                const audioUrl = this.dataset.audioUrl;
                playVoicePreview(audioUrl, this);
            });
        });
    }
    
    function playVoicePreview(audioUrl, button) {
        if (currentAudio) {
            currentAudio.pause();
            currentAudio = null;
            document.querySelectorAll('.play-voice-btn').forEach(btn => {
                btn.innerHTML = '<i class="fas fa-play"></i> Preview';
                btn.classList.remove('btn-danger');
                btn.classList.add('btn-outline-primary');
            });
        }
        
        if (button.innerHTML.includes('fa-stop')) {
            return;
        }
        
        currentAudio     = new Audio(audioUrl);
        button.innerHTML = '<i class="fas fa-stop"></i> Detener';
        button.classList.remove('btn-outline-primary');
        button.classList.add('btn-danger');
        
        currentAudio.play().catch(error => {
            console.error('Error al reproducir audio:', error);
            alert('No se pudo reproducir el preview de audio');
            button.innerHTML = '<i class="fas fa-play"></i> Preview';
            button.classList.remove('btn-danger');
            button.classList.add('btn-outline-primary');
        });
        
        currentAudio.addEventListener('ended', function() {
            button.innerHTML = '<i class="fas fa-play"></i> Preview';
            button.classList.remove('btn-danger');
            button.classList.add('btn-outline-primary');
            currentAudio = null;
        });
    }

});

</script>
{% endblock %}