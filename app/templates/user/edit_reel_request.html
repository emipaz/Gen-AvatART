{% extends "base.html" %}

{% block title %}Editar Reel - {{ super() }}{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="h3 mb-0">九勇 Editar Reel</h1>
                    <small class="text-muted">Modifica tu borrador antes de enviarlo al productor</small>
                </div>
                <a href="{{ url_for('user.my_reels') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left"></i> Volver
                </a>
            </div>

            <!-- Informaci칩n del avatar -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-3">
                            {% if reel_request.avatar.thumbnail_url %}
                                <img src="{{ reel_request.avatar.thumbnail_url }}" 
                                     alt="{{ reel_request.avatar.name }}" 
                                     class="img-fluid rounded"
                                     style="width: 100%; height: auto; max-height: 120px; object-fit: cover;">
                            {% else %}
                                <div class="bg-light rounded d-flex align-items-center justify-content-center" 
                                     style="width: 100%; height: 120px;">
                                    <i class="fas fa-user fa-3x text-muted"></i>
                                </div>
                            {% endif %}
                        </div>
                        <div class="col-md-9">
                            <h5 class="mb-1">{{ reel_request.avatar.name }}</h5>
                            <p class="text-muted mb-1">
                                <i class="fas fa-building"></i> 
                                {{ reel_request.producer.display_name }}
                            </p>
                            <small class="text-muted">
                                Creado el: {{ reel_request.created_at.strftime('%d/%m/%Y a las %H:%M') }}
                            </small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Formulario de edici칩n -->
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <form method="POST" enctype="multipart/form-data">
                        {{ form.hidden_tag() }}
                        
                        <!-- T칤tulo -->
                        <div class="mb-3">
                            {{ form.title.label(class="form-label") }}
                            {{ form.title(class="form-control") }}
                            {% if form.title.errors %}
                                <div class="text-danger small">
                                    {% for error in form.title.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <div class="form-text">Un t칤tulo descriptivo para tu reel</div>
                        </div>

                        <!-- Script -->
                        <div class="mb-3">
                            {{ form.script.label(class="form-label") }}
                            {{ form.script(class="form-control", rows="6") }}
                            {% if form.script.errors %}
                                <div class="text-danger small">
                                    {% for error in form.script.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <div class="form-text">
                                El texto que dir치 el avatar. Escribe de forma natural y clara.
                            </div>
                        </div>

                        <!-- Selector de Voz -->
                        <div class="mb-3">
                            {{ form.voice_id.label(class="form-label") }}
                            <!-- Campo hidden para capturar el voice_id seleccionado -->
                            {{ form.voice_id(type="hidden", id="voice_id_field") }}
                            <div id="voice-required-info" class="alert alert-info mb-2" style="display: none;">
                                <i class="fas fa-info-circle"></i>
                                <span id="voice-required-message"></span>
                            </div>
                            <div id="voice-selector-container">
                                <div class="text-center py-4">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Cargando voces...</span>
                                    </div>
                                    <p class="text-muted mt-2">Cargando voces disponibles...</p>
                                </div>
                            </div>
                            <div class="form-text">
                                <span id="voice-help-text">Selecciona la voz que usar치 el avatar. Puedes escuchar una muestra antes de elegir.</span>
                            </div>
                        </div>

                        <!-- Resoluci칩n -->
                        <div class="mb-3">
                            {{ form.resolution.label(class="form-label") }}
                            {{ form.resolution(class="form-select") }}
                            {% if form.resolution.errors %}
                                <div class="text-danger small">
                                    {% for error in form.resolution.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <div class="form-text">Calidad del video final</div>
                        </div>

                        <!-- Imagen de Fondo -->
                        <div class="mb-3">
                            <label class="form-label">Imagen de Fondo</label>
                            
                            <!-- Tabs para seleccionar entre URL y Upload -->
                            <ul class="nav nav-tabs mb-3" id="backgroundTabs" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="url-tab" data-bs-toggle="tab" 
                                            data-bs-target="#url-pane" type="button" role="tab">
                                        <i class="fas fa-link"></i> URL de Imagen
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="upload-tab" data-bs-toggle="tab" 
                                            data-bs-target="#upload-pane" type="button" role="tab">
                                        <i class="fas fa-upload"></i> Subir Imagen
                                    </button>
                                </li>
                            </ul>
                            
                            <!-- Tab Content -->
                            <div class="tab-content" id="backgroundTabContent">
                                <!-- URL Tab -->
                                <div class="tab-pane fade show active" id="url-pane" role="tabpanel">
                                    {{ form.background_url(class="form-control", 
                                                          placeholder="https://ejemplo.com/imagen.jpg") }}
                                    {% if form.background_url.errors %}
                                        <div class="text-danger small">
                                            {% for error in form.background_url.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                    <div class="form-text">
                                        Proporciona la URL de una imagen de fondo p칰blica
                                    </div>
                                </div>
                                
                                <!-- Upload Tab -->
                                <div class="tab-pane fade" id="upload-pane" role="tabpanel">
                                    {{ form.background_image(class="form-control") }}
                                    {% if form.background_image.errors %}
                                        <div class="text-danger small">
                                            {% for error in form.background_image.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                    <div class="form-text">
                                        Sube una imagen desde tu computadora (JPG, PNG, WebP)
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Alert informativo -->
                            <div class="alert alert-info mt-2 small">
                                <i class="fas fa-info-circle"></i>
                                Si subes un archivo, se usar치 en lugar de la URL. Si no proporcionas ninguna, 
                                se usar치 un fondo por defecto.
                            </div>
                        </div>

                        <!-- Notas para el productor -->
                        <div class="mb-4">
                            {{ form.user_notes.label(class="form-label") }}
                            {{ form.user_notes(class="form-control", rows="3") }}
                            {% if form.user_notes.errors %}
                                <div class="text-danger small">
                                    {% for error in form.user_notes.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <div class="form-text">
                                Comentarios adicionales o instrucciones especiales para el productor (opcional)
                            </div>
                        </div>

                        <!-- Botones -->
                        <div class="d-flex justify-content-between">
                            <a href="{{ url_for('user.my_reels') }}" class="btn btn-outline-secondary">
                                <i class="fas fa-times"></i> Cancelar
                            </a>
                            <div>
                                <button type="submit" class="btn btn-success me-2">
                                    <i class="fas fa-save"></i> Guardar Cambios
                                </button>
                                <a href="{{ url_for('user.my_reels') }}" class="btn btn-primary" 
                                   onclick="return confirm('쯈uieres guardar los cambios primero?')">
                                    <i class="fas fa-paper-plane"></i> Guardar y Enviar
                                </a>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Informaci칩n adicional -->
            <div class="card border-0 shadow-sm mt-4 bg-light">
                <div class="card-body">
                    <h6 class="mb-3">游눠 Consejos para tu reel</h6>
                    <ul class="small text-muted mb-0">
                        <li>Escribe el script de forma natural, como si fueras a hablarlo</li>
                        <li>Evita palabras t칠cnicas complejas o nombres dif칤ciles de pronunciar</li>
                        <li>El avatar hablar치 en el idioma que hayas configurado</li>
                        <li>Puedes usar puntuaci칩n para controlar las pausas</li>
                        <li>Una vez enviado al productor, no podr치s editar la solicitud</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const avatarId = {{ reel_request.avatar.id }};
    const voiceContainer = document.getElementById('voice-selector-container');
    const currentVoiceId = {% if reel_request.voice_id %}'{{ reel_request.voice_id }}'{% else %}null{% endif %};
    let currentAudio = null;
    let allVoices = [];
    let defaultVoiceId = null;
    const formElement = document.querySelector('form');
    
    console.log('Voice ID actual del reel:', currentVoiceId);
    
    // Mostrar info sobre voz requerida/opcional
    function updateVoiceRequiredInfo() {
        const infoDiv = document.getElementById('voice-required-info');
        const messageSpan = document.getElementById('voice-required-message');
        const helpText = document.getElementById('voice-help-text');
        
        // Validar que los elementos existan
        if (!infoDiv || !messageSpan || !helpText) {
            console.warn('Elementos de info de voz no encontrados en el DOM');
            return;
        }
        
        if (defaultVoiceId) {
            infoDiv.style.display = 'block';
            infoDiv.className = 'alert alert-success mb-2';
            messageSpan.textContent = 'Este avatar tiene una voz predeterminada. Puedes dejarla seleccionada o elegir otra.';
            helpText.textContent = 'Opcional: Puedes cambiar la voz si lo deseas.';
        } else {
            infoDiv.style.display = 'block';
            infoDiv.className = 'alert alert-warning mb-2';
            messageSpan.innerHTML = '<strong>Importante:</strong> Este avatar no tiene voz predeterminada. Debes seleccionar una.';
            helpText.textContent = 'Obligatorio: Selecciona una voz para continuar.';
        }
    }
    
    // Validaci칩n antes de enviar el formulario
    formElement.addEventListener('submit', function(e) {
        if (!defaultVoiceId) {
            // Si no hay voz por defecto, verificar que se haya seleccionado una
            const selectedVoice = document.querySelector('input[name="voice_id"]:checked');
            if (!selectedVoice || !selectedVoice.value) {
                e.preventDefault();
                alert('Por favor, selecciona una voz para el avatar antes de continuar.');
                
                // Hacer scroll hasta el selector de voces
                document.getElementById('voice-selector-container').scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'center' 
                });
                return false;
            }
        }
    });
    
    // Cargar voces disponibles
    fetch(`/api/avatars/${avatarId}/voices`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                voiceContainer.innerHTML = `
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i> 
                        <strong>Problema al cargar voces:</strong><br>
                        ${data.error}
                        <hr>
                        <small>
                            <i class="fas fa-info-circle"></i> 
                            Puedes continuar editando el reel. Si el avatar tiene una voz predeterminada, se usar치 autom치ticamente.
                            ${data.default_voice_id ? `<br><strong>Voz predeterminada disponible:</strong> Se usar치 la voz original del avatar.` : ''}
                        </small>
                    </div>
                `;
                // Si hay voz por defecto, actualizar la info
                if (data.default_voice_id) {
                    defaultVoiceId = data.default_voice_id;
                    updateVoiceRequiredInfo();
                }
                return;
            }
            
            allVoices = data.voices;
            defaultVoiceId = data.default_voice_id;
            updateVoiceRequiredInfo();
            renderVoiceSelector(allVoices);
        })
        .catch(error => {
            console.error('Error al cargar voces:', error);
            voiceContainer.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-times-circle"></i> 
                    <strong>Error de conexi칩n</strong><br>
                    No se pudieron cargar las voces disponibles. Verifica tu conexi칩n e intenta recargar la p치gina.
                </div>
            `;
        });
    
    function renderVoiceSelector(voices) {
        if (!voices || voices.length === 0) {
            voiceContainer.innerHTML = `
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> 
                    No hay voces disponibles para este avatar
                </div>
            `;
            return;
        }
        
        // Extraer idiomas y g칠neros 칰nicos
        const languages = [...new Set(voices.map(v => v.language))].sort();
        const genders = [...new Set(voices.map(v => v.gender))].sort();
        
        // Capitalizar primera letra de gender para display
        const capitalizeFirst = (str) => str.charAt(0).toUpperCase() + str.slice(1);
        
        let html = `
            <!-- Filtros -->
            <div class="card mb-3">
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label for="search-voice" class="form-label">
                                <i class="fas fa-search"></i> Buscar por nombre
                            </label>
                            <input type="text" 
                                   class="form-control" 
                                   id="search-voice" 
                                   placeholder="Escribe para buscar...">
                        </div>
                        <div class="col-md-4">
                            <label for="filter-language" class="form-label">
                                <i class="fas fa-language"></i> Idioma
                            </label>
                            <select class="form-select" id="filter-language">
                                <option value="">Todos los idiomas (${voices.length})</option>
                                ${languages.map(lang => {
                                    const count = voices.filter(v => v.language === lang).length;
                                    return `<option value="${lang}">${lang} (${count})</option>`;
                                }).join('')}
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="filter-gender" class="form-label">
                                <i class="fas fa-venus-mars"></i> G칠nero
                            </label>
                            <select class="form-select" id="filter-gender">
                                <option value="">Todos (${voices.length})</option>
                                ${genders.map(gender => {
                                    const count = voices.filter(v => v.gender === gender).length;
                                    return `<option value="${gender}">${capitalizeFirst(gender)} (${count})</option>`;
                                }).join('')}
                            </select>
                        </div>
                    </div>
                    <div class="mt-2">
                        <small class="text-muted">
                            <i class="fas fa-info-circle"></i> 
                            Mostrando <span id="voice-count">${voices.length}</span> de ${allVoices.length} voces
                        </small>
                    </div>
                </div>
            </div>
            
            <!-- Lista de voces -->
            <div id="voices-list">
        `;
        
        // Si hay voz por defecto, agregar opci칩n para mantenerla (SIEMPRE VISIBLE, FUERA DEL SCROLL)
        if (defaultVoiceId) {
            const isDefaultSelected = !currentVoiceId || currentVoiceId === '';
            html += `
                <div class="card mb-3 border-success">
                    <div class="card-body p-3 bg-light">
                        <div class="list-group-item list-group-item-action voice-option-default border-success ${isDefaultSelected ? 'active' : ''}" 
                             data-voice-id=""
                             style="cursor: pointer; background-color: #d1f4d1; border: 2px solid #28a745;">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="flex-grow-1">
                                    <div class="d-flex align-items-center">
                                        <input type="radio" 
                                               name="voice_id" 
                                               value="" 
                                               id="voice_default"
                                               ${isDefaultSelected ? 'checked' : ''}
                                               class="form-check-input me-2">
                                        <label for="voice_default" class="mb-0 flex-grow-1" style="cursor: pointer;">
                                            <strong><i class="fas fa-check-circle text-success"></i> Usar voz predeterminada del avatar</strong>
                                            <span class="badge bg-success ms-2">Recomendado</span>
                                            <br>
                                            <small class="text-muted">
                                                <i class="fas fa-info-circle"></i> Esta es la voz original del avatar. Siempre disponible independiente de los filtros.
                                            </small>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="mb-2">
                    <strong><i class="fas fa-list"></i> O elige una voz diferente:</strong>
                </div>
            `;
        }
        
        // Contenedor con scroll para otras voces
        html += `<div class="voices-scrollable-list" style="max-height: 400px; overflow-y: auto;">`;
        
        voices.forEach(voice => {
            const isDefault = voice.is_default;
            const badgeClass = 'bg-secondary';
            const badgeText = isDefault ? 'Voz original del avatar' : '';
            const isSelected = currentVoiceId === voice.voice_id;
            
            html += `
                <div class="list-group-item list-group-item-action voice-option ${isSelected ? 'active' : ''}" 
                     data-voice-id="${voice.voice_id}"
                     data-language="${voice.language}"
                     data-gender="${voice.gender}"
                     data-name="${voice.name.toLowerCase()}"
                     style="cursor: pointer;">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="flex-grow-1">
                            <div class="d-flex align-items-center">
                                <input type="radio" 
                                       name="voice_id" 
                                       value="${voice.voice_id}" 
                                       id="voice_${voice.voice_id}"
                                       ${isSelected ? 'checked' : ''}
                                       class="form-check-input me-2">
                                <label for="voice_${voice.voice_id}" class="mb-0 flex-grow-1" style="cursor: pointer;">
                                    <strong>${voice.name}</strong>
                                    ${badgeText ? `<span class="badge ${badgeClass} ms-2">${badgeText}</span>` : ''}
                                    <br>
                                    <small class="text-muted">
                                        <i class="fas fa-language"></i> ${voice.language} 
                                        <i class="fas fa-${voice.gender === 'male' ? 'mars' : voice.gender === 'female' ? 'venus' : 'genderless'} ms-2"></i> 
                                        ${voice.gender}
                                    </small>
                                </label>
                            </div>
                        </div>
                        ${voice.preview_audio ? `
                        <button type="button" 
                                class="btn btn-sm btn-outline-primary play-voice-btn ms-2" 
                                data-audio-url="${voice.preview_audio}"
                                data-voice-id="${voice.voice_id}">
                            <i class="fas fa-play"></i> Preview
                        </button>
                        ` : ''}
                    </div>
                </div>
            `;
        });
        
        html += '</div></div>'; // Cerrar voices-scrollable-list y voices-list
        voiceContainer.innerHTML = html;
        
        // Actualizar campo hidden con la voz actual
        const hiddenField = document.getElementById('voice_id_field');
        if (hiddenField) {
            if (currentVoiceId) {
                hiddenField.value = currentVoiceId;
                console.log('Campo hidden actualizado con voz actual:', currentVoiceId);
                
                // Hacer scroll a la voz seleccionada despu칠s de un peque침o delay
                setTimeout(() => {
                    const selectedVoiceElement = document.querySelector(`.voice-option[data-voice-id="${currentVoiceId}"]`);
                    if (selectedVoiceElement) {
                        selectedVoiceElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        console.log('Scroll a voz seleccionada:', currentVoiceId);
                    }
                }, 100);
            } else if (!currentVoiceId && defaultVoiceId) {
                // Si no hay voz seleccionada pero hay default, dejar vac칤o (usa default)
                hiddenField.value = '';
                console.log('Sin voz espec칤fica, usando voz predeterminada del avatar');
            }
        }
        
        // Event listener para la opci칩n de voz predeterminada (fuera del filtrado)
        const defaultOption = document.querySelector('.voice-option-default');
        if (defaultOption) {
            defaultOption.addEventListener('click', function(e) {
                const radio = document.getElementById('voice_default');
                radio.checked = true;
                
                // Actualizar campo hidden
                const hiddenField = document.getElementById('voice_id_field');
                if (hiddenField) {
                    hiddenField.value = radio.value;
                }
                
                // Desmarcar todas las otras voces
                document.querySelectorAll('.voice-option').forEach(opt => {
                    opt.classList.remove('active');
                });
                this.classList.add('active');
            });
        }
        
        // Event listeners para filtros
        document.getElementById('search-voice').addEventListener('input', filterVoices);
        document.getElementById('filter-language').addEventListener('change', filterVoices);
        document.getElementById('filter-gender').addEventListener('change', filterVoices);
        
        // Event listeners para seleccionar voz
        attachVoiceListeners();
    }
    
    function filterVoices() {
        const searchTerm = document.getElementById('search-voice').value.toLowerCase();
        const selectedLanguage = document.getElementById('filter-language').value;
        const selectedGender = document.getElementById('filter-gender').value;
        
        const voiceOptions = document.querySelectorAll('.voice-option');
        let visibleCount = 0;
        
        voiceOptions.forEach(option => {
            const name = option.dataset.name;
            const language = option.dataset.language;
            const gender = option.dataset.gender;
            
            const matchesSearch = !searchTerm || name.includes(searchTerm);
            const matchesLanguage = !selectedLanguage || language === selectedLanguage;
            const matchesGender = !selectedGender || gender === selectedGender;
            
            if (matchesSearch && matchesLanguage && matchesGender) {
                option.style.display = '';
                visibleCount++;
            } else {
                option.style.display = 'none';
            }
        });
        
        // Actualizar contador
        document.getElementById('voice-count').textContent = visibleCount;
    }
    
    function attachVoiceListeners() {
        // Event listeners para seleccionar voz (solo las voces dentro del scroll)
        document.querySelectorAll('.voice-option').forEach(option => {
            option.addEventListener('click', function(e) {
                if (e.target.closest('.play-voice-btn')) return;
                
                const voiceId = this.dataset.voiceId;
                const radio = document.getElementById(`voice_${voiceId}`);
                radio.checked = true;
                
                // Actualizar campo hidden
                const hiddenField = document.getElementById('voice_id_field');
                if (hiddenField) {
                    hiddenField.value = voiceId;
                }
                
                document.querySelectorAll('.voice-option').forEach(opt => {
                    opt.classList.remove('active');
                });
                
                // Desmarcar la opci칩n predeterminada si existe
                const defaultOption = document.querySelector('.voice-option-default');
                if (defaultOption) {
                    defaultOption.classList.remove('active');
                }
                
                this.classList.add('active');
            });
        });
        
        // Event listeners para preview de audio
        document.querySelectorAll('.play-voice-btn').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.stopPropagation();
                const audioUrl = this.dataset.audioUrl;
                playVoicePreview(audioUrl, this);
            });
        });
    }
    
    function playVoicePreview(audioUrl, button) {
        if (currentAudio) {
            currentAudio.pause();
            currentAudio = null;
            document.querySelectorAll('.play-voice-btn').forEach(btn => {
                btn.innerHTML = '<i class="fas fa-play"></i> Preview';
                btn.classList.remove('btn-danger');
                btn.classList.add('btn-outline-primary');
            });
        }
        
        if (button.innerHTML.includes('fa-stop')) {
            return;
        }
        
        currentAudio = new Audio(audioUrl);
        button.innerHTML = '<i class="fas fa-stop"></i> Detener';
        button.classList.remove('btn-outline-primary');
        button.classList.add('btn-danger');
        
        currentAudio.play().catch(error => {
            console.error('Error al reproducir audio:', error);
            alert('No se pudo reproducir el preview de audio');
            button.innerHTML = '<i class="fas fa-play"></i> Preview';
            button.classList.remove('btn-danger');
            button.classList.add('btn-outline-primary');
        });
        
        currentAudio.addEventListener('ended', function() {
            button.innerHTML = '<i class="fas fa-play"></i> Preview';
            button.classList.remove('btn-danger');
            button.classList.add('btn-outline-primary');
            currentAudio = null;
        });
    }
    
    // Contador de caracteres para el script
    const scriptTextarea = document.querySelector('#script');
    if (scriptTextarea) {
        const maxLength = 2000;
        const counterDiv = document.createElement('div');
        counterDiv.className = 'form-text text-end';
        scriptTextarea.parentNode.appendChild(counterDiv);
        
        function updateCounter() {
            const remaining = maxLength - scriptTextarea.value.length;
            counterDiv.textContent = `${scriptTextarea.value.length}/${maxLength} caracteres`;
            counterDiv.className = remaining < 100 ? 'form-text text-end text-warning' : 'form-text text-end';
        }
        
        scriptTextarea.addEventListener('input', updateCounter);
        updateCounter();
    }
});
</script>
{% endblock %}