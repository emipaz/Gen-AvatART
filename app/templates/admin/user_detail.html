{#
Template de detalle de usuario para panel administrativo de Gem-AvatART.

Este template implementa la vista detallada de un usuario específico con información
completa, estadísticas de actividad y opciones administrativas. Incluye funcionalidad
de promoción de usuarios finales a productores con formulario modal completo.

El template incluye:
    - Breadcrumb de navegación administrativo
    - Header con información básica del usuario y avatar placeholder
    - Cards de información general (rol, estado, fechas)
    - Métricas de actividad (reels, comisiones, estadísticas)
    - Estadísticas adicionales para productores (avatares, API)
    - Botones de acciones administrativas contextuales
    - Modal de promoción a productor con configuración completa
    - Validaciones de estado para habilitar/deshabilitar acciones

Clases Bootstrap utilizadas:
    - Layout: container, row, col-*, g-3, d-flex, align-items-center
    - Navigation: breadcrumb, breadcrumb-item
    - Cards: card, card-body, h-100
    - Components: modal, modal-dialog, modal-content, modal-header, modal-body, modal-footer
    - Forms: form-label, form-control, btn, btn-sm
    - Typography: display-6, text-muted, fw-semibold, small
    - Colors: text-success, btn-success, btn-warning, btn-danger, btn-primary, btn-secondary
    - Utilities: my-4, mb-3, me-3, gap-2, flex-wrap

Variables Jinja utilizadas:
    - user: Objeto User con toda la información del usuario
    - stats: Diccionario con estadísticas calculadas del usuario
    - user.role.value: Valor del enum de rol
    - user.status.value: Valor del enum de estado
    - user.created_at: Fecha de registro
    - user.last_login: Último acceso
    - user.full_name: Nombre completo calculado
    - user.is_producer(): Método para verificar si es productor
    - user.producer_profile: Perfil de productor si existe

Estadísticas mostradas (stats):
    - total_reels: Total de reels creados
    - completed_reels: Reels completados exitosamente
    - total_commissions: Número total de comisiones
    - pending_earnings: Ganancias pendientes
    - avatars_count: Avatares creados (solo productores)
    - api_calls_this_month: Llamadas API del mes (solo productores)
    - monthly_api_limit: Límite mensual de API (solo productores)

Rutas Flask referenciadas (url_for):
    - admin.dashboard: Dashboard administrativo
    - admin.users: Lista de usuarios
    - admin.approve_user: Aprobar usuario
    - admin.suspend_user: Suspender usuario
    - admin.delete_user: Eliminar usuario
    - admin.promote_to_producer: Promocionar a productor

Campos del formulario de promoción (name attributes):
    - company_name: Nombre de la empresa
    - business_type: Tipo de negocio
    - website: Sitio web (opcional)
    - max_subproducers: Límite máximo de subproductores
    - max_affiliates: Límite máximo de afiliados
    - monthly_api_limit: Límite mensual de llamadas API

IDs de elementos:
    - promoteModal: Modal de promoción a productor
    - promoteModalLabel: Label del modal de promoción

Iconografía Font Awesome:
    - fas fa-user: Usuario genérico
    - fas fa-check: Aprobar acción
    - fas fa-ban: Suspender usuario
    - fas fa-arrow-up: Promocionar usuario
    - fas fa-trash-alt: Eliminar usuario
    - fas fa-info-circle: Información adicional
    - fas fa-exclamation-triangle: Advertencia importante

Validaciones condicionales:
    - Botón aprobar: habilitado si estado es 'pending' o 'suspended'
    - Botón suspender: habilitado solo si estado es 'active'
    - Botón promocionar: visible solo para 'final_user' activos
    - Modal promoción: se muestra solo para usuarios elegibles
    - Métricas de productor: solo para usuarios con rol productor

Métodos Jinja utilizados:
    - user.created_at.strftime(): Formateo de fecha de registro
    - user.last_login.strftime(): Formateo de último acceso
    - user.role.value: Acceso al valor del enum de rol
    - user.status.value: Acceso al valor del enum de estado
    - user.is_producer(): Verificación de rol de productor
    - user.full_name: Nombre completo con fallback a username

Validación de formularios:
    - type="url": Validación HTML5 para sitio web
    - type="number": Validación numérica para límites
    - min/max: Rangos permitidos para valores numéricos
    - required: Campos obligatorios (implícito en algunos casos)
    - onsubmit: Confirmación JavaScript para eliminación

Lógica condicional implementada:
    - Habilitación de botones según estado del usuario
    - Visibilidad de métricas según rol del usuario
    - Mostrar modal solo para usuarios elegibles
    - Valores por defecto inteligentes en formulario de promoción

Seguridad implementada:
    - Confirmación JavaScript para acción de eliminación
    - Validación de estado para habilitar acciones
    - Formularios POST separados para cada acción crítica
    - Validaciones de rol para mostrar opciones específicas
#}

{% extends "base.html" %}
{% block title %}Detalle de Usuario{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="row">
    <!-- ===== SIDEBAR DE NAVEGACIÓN ADMINISTRATIVA ===== -->
    <div class="col-md-3 col-lg-2 px-0">
      <div class="sidebar" style="background: linear-gradient(135deg, hwb(190 47% 24%) 0%, #fdfdfd 100%); min-height: calc(100vh - 120px); color: #010101;">
        <div class="p-3">
          <h5><i class="fas fa-tachometer-alt"></i> Admin Panel</h5>
        </div>
        <nav class="nav flex-column">
          <a class="nav-link" href="{{ url_for('admin.dashboard') }}" style="color: #010101;">
            <i class="fas fa-home" style="color: #010101;"></i> Dashboard
          </a>
          <a class="nav-link active" href="{{ url_for('admin.users') }}" style="color: #010101;">
            <i class="fas fa-users" style="color: #010101;"></i> Usuarios
          </a>
          <a class="nav-link" href="{{ url_for('admin.producers') }}" style="color: #010101;">
            <i class="fas fa-industry" style="color: #010101;"></i> Productores
          </a>
          <a class="nav-link" href="{{ url_for('admin.avatars') }}" style="color: #010101;">
            <i class="fas fa-user-circle" style="color: #010101;"></i> Avatars
          </a>
          <a class="nav-link" href="{{ url_for('admin.reels') }}" style="color: #010101;">
            <i class="fas fa-video"></i> Reels
          </a>
          <a class="nav-link" href="{{ url_for('admin.commissions') }}" style="color: #010101;">
            <i class="fas fa-dollar-sign"></i> Comisiones
          </a>
        </nav>
      </div>
    </div>

    <!-- ===== CONTENIDO PRINCIPAL DEL DETALLE DE USUARIO ===== -->
    <div class="col-md-9 col-lg-10">
      <!-- Migas de pan -->
      <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a href="{{ url_for('admin.dashboard') }}">Dashboard</a></li>
          <li class="breadcrumb-item"><a href="{{ url_for('admin.users') }}">Usuarios</a></li>
          <li class="breadcrumb-item active" aria-current="page">Detalle</li>
        </ol>
      </nav>
      <!-- Header principal con avatar y datos básicos -->
      <div class="d-flex align-items-center mb-3">
        <div class="me-3">
          <span class="rounded-circle bg-light d-inline-flex align-items-center justify-content-center" style="width:56px;height:56px;">
            <i class="fas fa-user fa-lg text-muted"></i>
          </span>
        </div>
        <div>
          <h3 class="mb-0">
            {{ (user.first_name ~ ' ' ~ user.last_name)|trim if (user.first_name or user.last_name) else user.username }}
          </h3>
          <div class="text-muted">{{ user.email }}</div>
        </div>
      </div>
      <!-- ...resto del contenido original... -->
    
    <!-- Card de rol del usuario -->
    <!-- col-6 en mobile (50% ancho), col-md-3 en desktop (25% ancho) -->
    <div class="col-6 col-md-3">
      <!-- Card con altura completa para alineación uniforme -->
      <!-- h-100 hace que todas las cards tengan la misma altura -->
      <div class="card h-100">
        <div class="card-body">
          <div class="text-muted small">Rol</div>
          <div class="fw-semibold">
            {% if user.is_owner %}
              <span class="badge bg-dark">Dueño</span>
            {% elif user.role.value == 'admin' %}
              <span class="badge bg-danger">Admin</span>
            {% else %}
              <span class="badge bg-{{ 'primary' if user.role.value == 'producer' else 'success' if user.role.value == 'subproducer' else 'info' }}">
                {{ user.role.value.title() }}
              </span>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
    
    <!-- Card de estado del usuario -->
    <div class="col-6 col-md-3">
      <div class="card h-100">
        <div class="card-body">
          <!-- Label para estado de la cuenta -->
          <div class="text-muted small">Estado</div>
          <!-- Valor del estado (active, pending, suspended) -->
          <div class="fw-semibold">{{ user.status.value if user.status else '—' }}</div>
        </div>
      </div>
    </div>
    
    <!-- Card de fecha de registro -->
    <div class="col-6 col-md-3">
      <div class="card h-100">
        <div class="card-body">
          <!-- Label para fecha de creación de cuenta -->
          <div class="text-muted small">Registro</div>
          <!-- Fecha formateada en formato DD/MM/YYYY HH:MM -->
          <!-- strftime formatea la fecha según el patrón especificado -->
          <div class="fw-semibold">{{ user.created_at.strftime('%d/%m/%Y %H:%M') if user.created_at else '—' }}</div>
        </div>
      </div>
    </div>
    
    <!-- Card de último acceso -->
    <div class="col-6 col-md-3">
      <div class="card h-100">
        <div class="card-body">
          <!-- Label para último inicio de sesión -->
          <div class="text-muted small">Último acceso</div>
          <!-- Fecha de último login formateada -->
          <!-- Muestra guión si nunca ha iniciado sesión -->
          <div class="fw-semibold">{{ user.last_login.strftime('%d/%m/%Y %H:%M') if user.last_login else '—' }}</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Grid de métricas de actividad y estadísticas del usuario -->
  <!-- Sección centrada con números grandes para visualización rápida -->
  <div class="row g-3 mb-4">
    
    <!-- Card de estadísticas de reels -->
    <div class="col-6 col-md-3">
      <div class="card h-100">
        <!-- text-center centra todo el contenido de la card -->
        <div class="card-body text-center">
          <!-- Label descriptivo para la métrica -->
          <div class="text-muted small">Reels</div>
          <!-- Número principal con clase display-6 para tamaño grande -->
          <!-- stats.total_reels viene del contexto con fallback a 0 -->
          <div class="display-6">{{ stats.total_reels or 0 }}</div>
          <!-- Información adicional con color de éxito -->
          <!-- text-success aplica color verde para información positiva -->
          <div class="text-success small">{{ stats.completed_reels or 0 }} completados</div>
        </div>
      </div>
    </div>
    
    <!-- Card de estadísticas de comisiones -->
    <div class="col-6 col-md-3">
      <div class="card h-100">
        <div class="card-body text-center">
          <!-- Label para comisiones generadas -->
          <div class="text-muted small">Comisiones</div>
          <!-- Total de comisiones con número grande -->
          <div class="display-6">{{ stats.total_commissions or 0 }}</div>
          <!-- Información adicional de ganancias pendientes -->
          <div class="small">Pendientes: {{ stats.pending_earnings or 0 }}</div>
        </div>
      </div>
    </div>

    <!-- Métricas adicionales solo para productores -->
    <!-- Condicional que verifica rol de productor Y existencia de perfil -->
    {% if user.is_producer() and user.producer_profile %}
    
    <!-- Card de avatares creados -->
    <div class="col-6 col-md-3">
      <div class="card h-100">
        <div class="card-body text-center">
          <!-- Label para avatares/clones digitales -->
          <div class="text-muted small">Avatares</div>
          <!-- Número de avatares creados por el productor -->
          <div class="display-6">{{ stats.avatars_count or 0 }}</div>
        </div>
      </div>
    </div>
    
    <!-- Card de uso de API mensual -->
    <div class="col-6 col-md-3">
      <div class="card h-100">
        <div class="card-body text-center">
          <!-- Label para llamadas API del mes actual -->
          <div class="text-muted small">API (mes)</div>
          <!-- Número de llamadas realizadas este mes -->
          <div class="display-6">{{ stats.api_calls_this_month or 0 }}</div>
          <!-- Información del límite mensual configurado -->
          <div class="small">Límite: {{ stats.monthly_api_limit or '—' }}</div>
        </div>
      </div>
    </div>
    {% endif %}
  </div>

  <!-- Sección de acciones administrativas rápidas -->
  <!-- d-flex crea layout flexbox horizontal -->
  <!-- gap-2 aplica espacio de 0.5rem entre elementos -->
  <!-- flex-wrap permite que los botones se envuelvan en pantallas pequeñas -->
  <div class="d-flex gap-2 flex-wrap">

    {% if current_user.is_owner %}
      <form method="post" action="{{ url_for('admin.approve_user', user_id=user.id) }}">
        <button class="btn {% if user.status.value|lower in ['pending', 'suspended'] %}btn-success{% else %}btn-secondary disabled{% endif %} btn-sm"
                {% if user.status.value|lower not in ['pending', 'suspended'] %}disabled aria-disabled="true"{% endif %}>
          <i class="fas fa-check me-1"></i> Aprobar
        </button>
      </form>
      <form method="post" action="{{ url_for('admin.suspend_user', user_id=user.id) }}">
        <button class="btn {% if user.status.value|lower == 'active' %}btn-warning{% else %}btn-secondary disabled{% endif %} btn-sm"
                {% if user.status.value|lower != 'active' %}disabled aria-disabled="true"{% endif %}>
          <i class="fas fa-ban me-1"></i> Suspender
        </button>
      </form>
      {% if not user.is_owner and user.is_admin %}
        <form method="post" action="{{ url_for('admin.delete_user', user_id=user.id) }}" onsubmit="return confirm('¿Seguro que deseas eliminar este administrador?');">
          <button class="btn btn-danger btn-sm">
            <i class="fas fa-trash-alt me-1"></i> Eliminar
          </button>
        </form>
      {% endif %}
    {% elif current_user.is_admin %}
      <form method="post" action="{{ url_for('admin.approve_user', user_id=user.id) }}">
        <button class="btn {% if user.status.value|lower in ['pending', 'suspended'] %}btn-success{% else %}btn-secondary disabled{% endif %} btn-sm"
                {% if user.status.value|lower not in ['pending', 'suspended'] %}disabled aria-disabled="true"{% endif %}>
          <i class="fas fa-check me-1"></i> Aprobar
        </button>
      </form>
      <form method="post" action="{{ url_for('admin.suspend_user', user_id=user.id) }}">
        <button class="btn {% if user.status.value|lower == 'active' %}btn-warning{% else %}btn-secondary disabled{% endif %} btn-sm"
                {% if user.status.value|lower != 'active' %}disabled aria-disabled="true"{% endif %}>
          <i class="fas fa-ban me-1"></i> Suspender
        </button>
      </form>
    {% endif %}
    {% if user.role.value == 'final_user' and user.status.value == 'active' %}
      <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#promoteModal">
        <i class="fas fa-arrow-up me-1"></i> Promocionar a Productor
      </button>
    {% endif %}
  </div>

  <!-- Modal para promocionar a productor -->
  {% if user.role.value == 'final_user' and user.status.value == 'active' %}
  <div class="modal fade" id="promoteModal" tabindex="-1" aria-labelledby="promoteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <form method="post" action="{{ url_for('admin.promote_to_producer', user_id=user.id) }}">
          <div class="modal-header">
            <h5 class="modal-title" id="promoteModalLabel">
              <i class="fas fa-arrow-up me-2"></i>Promocionar a Productor
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="alert alert-info">
              <i class="fas fa-info-circle me-2"></i>
              <strong>{{ user.full_name }}</strong> será promocionado a Productor y podrá:
              <ul class="mb-0 mt-2">
                <li>Crear avatares digitales</li>
                <li>Gestionar equipos de subproductores</li>
                <li>Configurar su API key de HeyGen</li>
                <li>Acceder a funciones avanzadas de producción</li>
              </ul>
            </div>

            <!-- Configuración del perfil de productor -->
            <div class="row g-3">
              <div class="col-12">
                <label class="form-label">Nombre de la empresa</label>
                <input type="text" name="company_name" class="form-control" 
                       value="{{ user.full_name }} Productions" 
                       placeholder="Ej: {{ user.full_name }} Productions">
                <small class="text-muted">Se puede cambiar después en configuración</small>
              </div>
              
              <div class="col-md-6">
                <label class="form-label">Tipo de negocio</label>
                <input type="text" name="business_type" class="form-control" 
                       value="Creador de Contenido" 
                       placeholder="Ej: Agencia Digital, Creador de Contenido">
              </div>
              
              <div class="col-md-6">
                <label class="form-label">Sitio web (opcional)</label>
                <input type="url" name="website" class="form-control" 
                       placeholder="https://ejemplo.com">
              </div>
              
              <div class="col-md-4">
                <label class="form-label">Máx. subproductores</label>
                <input type="number" name="max_subproducers" class="form-control" 
                       value="10" min="1" max="100">
              </div>
              
              <div class="col-md-4">
                <label class="form-label">Máx. afiliados</label>
                <input type="number" name="max_affiliates" class="form-control" 
                       value="100" min="1" max="1000">
              </div>
              
              <div class="col-md-4">
                <label class="form-label">Límite API mensual</label>
                <input type="number" name="monthly_api_limit" class="form-control" 
                       value="1000" min="100" max="10000">
              </div>
            </div>

            <div class="alert alert-warning mt-3">
              <i class="fas fa-exclamation-triangle me-2"></i>
              <strong>Importante:</strong> Después de la promoción, el usuario deberá configurar 
              su API key de HeyGen para poder crear avatares.
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-arrow-up me-1"></i> Promocionar a Productor
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
  {% endif %}
</div>
{% endblock %}
